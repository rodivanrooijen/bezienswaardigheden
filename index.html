<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AI Travel Assistant</title>
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <script src="https://unpkg.com/react@latest/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@latest/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone@latest/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const {
            colors,
            CssBaseline,
            ThemeProvider,
            Typography,
            TextField,
            Container,
            createTheme,
            Box,
            Skeleton,
        } = MaterialUI;

        const theme = createTheme({
            palette: {
                mode: 'light'
            },
        });

        const App = () => {
            const [response, setResponse] = React.useState("");
            const [question, setQuestion] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const [socket, setSocket] = React.useState(null);

            React.useEffect(() => {
                const newSocket = new WebSocket("wss://ycn24bezienswaardigheden.azurewebsites.net:8000/ws");
                setSocket(newSocket);
                return () => newSocket.close();
            }, []);

            React.useEffect(() => {
                if (!socket) return;

                socket.onmessage = (event) => {
                    setLoading(false);
                    setResponse(marked.parse(event.data));
                };

                socket.onopen = () => {
                    console.log("WebSocket connected");
                };

                socket.onclose = () => {
                    console.log("WebSocket closed");
                };

                return () => {
                    socket.close();
                };
            }, [socket]);

            const sendQuestion = () => {
                if (!socket) {
                    console.error('WebSocket connection is not open.');
                    return;
                }

                setLoading(true);
                setResponse('');
                socket.send(question);
            };

            return (
                <ThemeProvider theme={theme}>
                    <CssBaseline />
                    <Container maxWidth="lg">
                        <Box sx={{ my: 4 }}>
                            <Typography variant="h4" component="h1" gutterBottom>
                                AI Travel Assistant
                            </Typography>
                            <TextField
                                id="outlined-basic"
                                label="Which City would you like to visit?"
                                variant="outlined"
                                style={{ width: '100%' }}
                                value={question}
                                disabled={loading}
                                onChange={(e) => setQuestion(e.target.value)}
                                onKeyUp={(e) => {
                                    if (e.key === "Enter") sendQuestion();
                                }}
                            />
                            <button onClick={sendQuestion} disabled={loading}>Send</button>
                        </Box>
                        {!response && loading && (
                            <>
                                <Skeleton />
                                <Skeleton animation="wave" />
                                <Skeleton animation={false} />
                            </>
                        )}
                        {response && (
                            <Typography dangerouslySetInnerHTML={{ __html: response }} />
                        )}
                    </Container>
                </ThemeProvider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(
            <App />
        );
    </script>
</body>

</html>